#!/bin/sh

set -e # fail on error

TVCDIR=${TVCDIR:-.} # default to current directory

. $TVCDIR/vars.sh

TIME=
if [ "$1" == "-t" ]; then
    TIME="/usr/bin/time -l"
    shift
fi

f=$1
shift
args=$@

declare -a words
declare -a extra_args

IFS=' ' read -r -a words < $f.c
if [ "${words[0]}" = "//" -a "${words[1]}" = "tvc-args:" ]; then
    extra_args=${words[@]:2}
fi

echo ==================================================
echo $f.c:
echo
cat $f.c
echo

$CLANGDIR/clang -c -emit-llvm $f.c -o $f.ll

echo ==================================================
echo $f.ll:
echo
llvm-dis $f.ll -o -
echo

export CSEMLIB_PATH=$CSEMDIR
export OCAMLRUNPARAM=b # generate stack trace on uncaught exception
$CSEMDIR/csem --impl $IMPL $f.c --pcore > $f.core

echo ==================================================
echo $f.core:
echo
cat $f.core

# It is necessary to use version 3.0 of clang, as the version of libllvm used by llvm2coqtext
# doesn't understand the LLVM bitcode format generated by more recent versions of clang.
$TVCDIR/main.d.byte $f.ll $CSEMDIR/corelib/std.core $CSEMDIR/corelib/impls/$IMPL.impl $f.core $f.v $extra_args $args

echo ==================================================
echo Coq says...
echo
if $TIME coqc -require coqharness -impredicative-set $COQINCLUDEOPTS $f; then
    echo $'\nValidation SUCCEEDED!'
    exit 0
else
    echo $'\nValidation FAILED!'
    exit 1
fi
